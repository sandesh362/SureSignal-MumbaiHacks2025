<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VeriPulse — AI Misinformation Verifier</title>

  <!-- Tailwind CDN (play CDN for quick prototypes) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide icons (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/lucide@0.259.0/dist/umd/lucide.min.js"></script>

  <style>
    /* small helper to limit long urls in cards */
    .truncate-url {
      display: inline-block;
      max-width: 60ch;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      vertical-align: middle;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">

  <div id="app" class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8 flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-indigo-900">VeriPulse</h1>
          <p class="text-sm text-gray-600 mt-1">AI-Powered Misinformation Detection</p>
        </div>
        <div class="flex gap-2">
          <button id="btnTrending" class="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
            <span data-feather="trending-up" class="lucide-icon"></span>
            <span>Trending</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8 flex-1">
      <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
        <!-- Mode buttons -->
        <div class="flex gap-4 mb-4">
          <button id="modeTextBtn" class="px-4 py-2 rounded-lg font-medium transition bg-indigo-600 text-white">Verify Text</button>
          <button id="modeUrlBtn" class="px-4 py-2 rounded-lg font-medium transition bg-gray-100 text-gray-700 hover:bg-gray-200 flex items-center gap-2">
            <span data-feather="external-link" class="lucide-icon"></span>
            <span>Verify URL</span>
          </button>
        </div>

        <!-- Text Mode -->
        <div id="textMode" class="block">
          <textarea id="inputText" placeholder="Paste a claim, tweet, or news snippet to verify..." class="w-full h-32 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"></textarea>
          <button id="verifyTextBtn" class="mt-4 w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 disabled:bg-gray-400 transition">Verify Claim</button>
        </div>

        <!-- URL Mode (hidden by default) -->
        <div id="urlMode" class="hidden">
          <input id="inputUrl" type="url" placeholder="https://example.com/article" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
          <button id="verifyUrlBtn" class="mt-4 w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 disabled:bg-gray-400 transition">Verify URL</button>
        </div>

        <!-- Error -->
        <div id="errorBox" class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg flex items-start gap-3 hidden">
          <svg id="errorIcon" class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12A9 9 0 103 12a9 9 0 0018 0z"></path></svg>
          <p id="errorText" class="text-red-800"></p>
        </div>
      </div>

      <!-- Result card placeholder -->
      <div id="resultCardContainer"></div>

      <!-- Trending list -->
      <div id="trendingContainer" class="bg-white rounded-2xl shadow-lg p-6 hidden">
        <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
          <span data-feather="trending-up" class="lucide-icon text-indigo-600"></span>
          Trending Verifications
        </h2>
        <div id="trendingList" class="space-y-3"></div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-12">
      <div class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
        <p class="text-center text-gray-600 text-sm">VeriPulse • Powered by AI • For Demo Purposes Only</p>
      </div>
    </footer>
  </div>

  <script>
    /**************************************************************************
     * CONFIG
     * Keep API_URL in one place — change if you're hosting the backend elsewhere
     **************************************************************************/
    const API_URL = (typeof REACT_APP_API_URL !== 'undefined' ? REACT_APP_API_URL : (window.__VERIPULSE_API_URL__ || 'http://localhost:5000'));
    // You can set `window.__VERIPULSE_API_URL__` from the page hosting environment
    // or edit the string above.

    /**************************************************************************
     * DOM REFERENCES
     **************************************************************************/
    const modeTextBtn = document.getElementById('modeTextBtn');
    const modeUrlBtn = document.getElementById('modeUrlBtn');
    const textMode = document.getElementById('textMode');
    const urlMode = document.getElementById('urlMode');
    const inputText = document.getElementById('inputText');
    const inputUrl = document.getElementById('inputUrl');
    const verifyTextBtn = document.getElementById('verifyTextBtn');
    const verifyUrlBtn = document.getElementById('verifyUrlBtn');
    const errorBox = document.getElementById('errorBox');
    const errorText = document.getElementById('errorText');
    const resultCardContainer = document.getElementById('resultCardContainer');
    const btnTrending = document.getElementById('btnTrending');
    const trendingContainer = document.getElementById('trendingContainer');
    const trendingList = document.getElementById('trendingList');

    /**************************************************************************
     * Verdict config maps to the React version (styles + lucide icon names)
     **************************************************************************/
    const verdictConfig = {
      TRUE:  { icon: 'check-circle', color: 'text-green-600', bg: 'bg-green-50', border: 'border-green-200' },
      FALSE: { icon: 'x-circle', color: 'text-red-600',   bg: 'bg-red-50',   border: 'border-red-200' },
      MISLEADING: { icon: 'alert-circle', color: 'text-yellow-600', bg: 'bg-yellow-50', border: 'border-yellow-200' },
      UNVERIFIED: { icon: 'help-circle', color: 'text-gray-600', bg: 'bg-gray-50', border: 'border-gray-200' }
    };

    /**************************************************************************
     * Helpers: create lucide icon
     **************************************************************************/
    function createLucide(name, classes = 'w-6 h-6') {
      // lucide.createIcon returns an SVG node. Use the UMD global `lucide`.
      try {
        const svg = lucide.createIcon(name, { class: classes });
        return svg;
      } catch (e) {
        // fallback: empty span
        const s = document.createElement('span');
        s.className = classes;
        return s;
      }
    }

    /**************************************************************************
     * UI Helpers
     **************************************************************************/
    function showError(msg) {
      errorText.textContent = msg;
      errorBox.classList.remove('hidden');
    }
    function clearError() {
      errorText.textContent = '';
      errorBox.classList.add('hidden');
    }

    function setMode(mode) {
      if (mode === 'text') {
        textMode.classList.remove('hidden');
        urlMode.classList.add('hidden');
        modeTextBtn.classList.add('bg-indigo-600', 'text-white');
        modeTextBtn.classList.remove('bg-gray-100','text-gray-700');
        modeUrlBtn.classList.remove('bg-indigo-600','text-white');
        modeUrlBtn.classList.add('bg-gray-100','text-gray-700');
      } else {
        textMode.classList.add('hidden');
        urlMode.classList.remove('hidden');
        modeUrlBtn.classList.add('bg-indigo-600','text-white');
        modeUrlBtn.classList.remove('bg-gray-100','text-gray-700');
        modeTextBtn.classList.remove('bg-indigo-600','text-white');
        modeTextBtn.classList.add('bg-gray-100','text-gray-700');
      }
    }

    /**************************************************************************
     * Fetch helpers (matches React logic and endpoints)
     **************************************************************************/
    async function verifyText() {
      clearError();
      const text = inputText.value || '';
      if (!text.trim()) {
        showError('Please enter a claim to verify');
        return;
      }

      setLoading(true);
      resultCardContainer.innerHTML = '';

      try {
        const resp = await fetch(`${API_URL}/api/verify`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });
        const data = await resp.json();
        if (!resp.ok) {
          throw new Error(data.error || 'Verification failed');
        }
        renderResult(data.data);
      } catch (err) {
        showError(err.message);
      } finally {
        setLoading(false);
      }
    }

    async function verifyUrl() {
      clearError();
      const url = inputUrl.value || '';
      if (!url.trim()) {
        showError('Please enter a URL to verify');
        return;
      }

      setLoading(true);
      resultCardContainer.innerHTML = '';

      try {
        const resp = await fetch(`${API_URL}/api/verify-url`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });
        const data = await resp.json();
        if (!resp.ok) {
          throw new Error(data.error || 'Verification failed');
        }
        renderResult(data.data);
      } catch (err) {
        showError(err.message);
      } finally {
        setLoading(false);
      }
    }

    async function fetchTrending() {
      try {
        const resp = await fetch(`${API_URL}/api/trending`);
        const data = await resp.json();
        if (data.success) {
          renderTrending(data.data || []);
        } else {
          console.warn('Trending fetch returned', data);
          renderTrending([]);
        }
      } catch (err) {
        console.error('Error fetching trending:', err);
        renderTrending([]);
      }
    }

    /**************************************************************************
     * Rendering: result card and trending items
     * Keep structure & field names (result.claim, result.verdict, result.confidence, result.explanation, result.evidence)
     **************************************************************************/
    function renderResult(result) {
      if (!result) return;
      // Build verdict style
      const cfg = verdictConfig[result.verdict] || verdictConfig.UNVERIFIED;

      // Create main card
      const container = document.createElement('div');
      container.className = `bg-white rounded-2xl shadow-lg p-6 mb-8 border-2 ${cfg.border}`;

      // Verdict header
      const header = document.createElement('div');
      header.className = `flex items-center gap-3 mb-4 p-4 rounded-lg ${cfg.bg}`;

      const iconNode = createLucide(cfg.icon, `w-8 h-8 ${cfg.color}`);
      header.appendChild(iconNode);

      const headerText = document.createElement('div');
      const title = document.createElement('h2');
      title.className = `text-2xl font-bold ${cfg.color}`;
      title.textContent = result.verdict;
      const conf = document.createElement('p');
      conf.className = 'text-sm text-gray-600';
      conf.textContent = `Confidence: ${(result.confidence * 100).toFixed(0)}%`;
      headerText.appendChild(title);
      headerText.appendChild(conf);

      header.appendChild(headerText);
      container.appendChild(header);

      // Claim
      const claimBlock = document.createElement('div');
      claimBlock.className = 'mb-4';
      const claimTitle = document.createElement('h3');
      claimTitle.className = 'font-semibold text-gray-900 mb-2';
      claimTitle.textContent = 'Claim:';
      const claimText = document.createElement('p');
      claimText.className = 'text-gray-700 bg-gray-50 p-3 rounded-lg';
      claimText.textContent = result.claim || '';
      claimBlock.appendChild(claimTitle);
      claimBlock.appendChild(claimText);
      container.appendChild(claimBlock);

      // Explanation with toggle (Detailed / ELI12)
      const explBlock = document.createElement('div');
      explBlock.className = 'mb-4';
      const explHeader = document.createElement('div');
      explHeader.className = 'flex items-center justify-between mb-2';
      const explTitle = document.createElement('h3');
      explTitle.className = 'font-semibold text-gray-900';
      explTitle.textContent = 'Explanation:';
      const toggleBtn = document.createElement('button');
      toggleBtn.className = 'text-sm text-indigo-600 hover:text-indigo-800';
      toggleBtn.textContent = 'Show Simple';
      explHeader.appendChild(explTitle);
      explHeader.appendChild(toggleBtn);
      explBlock.appendChild(explHeader);

      const explText = document.createElement('p');
      explText.className = 'text-gray-700 leading-relaxed';
      const detailed = (result.explanation && result.explanation.detailed_explanation) || '';
      const eli12 = (result.explanation && result.explanation.eli12_explanation) || '';
      explText.textContent = detailed || eli12 || (result.reasoning || '');
      explBlock.appendChild(explText);
      container.appendChild(explBlock);

      // Toggle behavior
      let showingEli12 = false;
      toggleBtn.addEventListener('click', () => {
        showingEli12 = !showingEli12;
        toggleBtn.textContent = showingEli12 ? 'Show Detailed' : 'Show Simple';
        explText.textContent = showingEli12 ? (eli12 || detailed) : (detailed || eli12);
      });

      // Evidence list
      if (result.evidence && result.evidence.length > 0) {
        const srcBlock = document.createElement('div');
        const srcTitle = document.createElement('h3');
        srcTitle.className = 'font-semibold text-gray-900 mb-3';
        srcTitle.textContent = 'Sources:';
        srcBlock.appendChild(srcTitle);

        const list = document.createElement('div');
        list.className = 'space-y-3';
        result.evidence.forEach((source, idx) => {
          const card = document.createElement('div');
          card.className = 'p-3 bg-gray-50 rounded-lg border border-gray-200';
          const inner = document.createElement('div');
          inner.className = 'flex items-start justify-between';
          const left = document.createElement('div');
          left.className = 'flex-1';
          const badge = document.createElement('span');
          badge.className = 'inline-block px-2 py-1 bg-indigo-100 text-indigo-800 text-xs font-semibold rounded uppercase mb-2';
          badge.textContent = (source.source || 'unknown').toUpperCase();
          const title = document.createElement('h4');
          title.className = 'font-medium text-gray-900 mb-1';
          title.textContent = source.title || 'Untitled';
          const link = document.createElement('a');
          link.href = source.url || '#';
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          link.className = 'text-sm text-indigo-600 hover:underline truncate-url block';
          link.textContent = source.url || '';

          left.appendChild(badge);
          left.appendChild(title);
          left.appendChild(link);

          const right = document.createElement('span');
          right.className = 'text-sm font-medium text-gray-600 ml-4';
          const relevance = (source.relevance_score || source.relevance || 0);
          right.textContent = `${Math.round(relevance*100)}%`;

          inner.appendChild(left);
          inner.appendChild(right);
          card.appendChild(inner);
          list.appendChild(card);
        });

        srcBlock.appendChild(list);
        container.appendChild(srcBlock);
      }

      // Attach to DOM
      resultCardContainer.innerHTML = '';
      resultCardContainer.appendChild(container);

      // Scroll to result
      container.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function renderTrending(items = []) {
      trendingList.innerHTML = '';
      if (!items || items.length === 0) {
        trendingContainer.classList.add('hidden');
        return;
      }
      trendingContainer.classList.remove('hidden');

      items.slice(0, 5).forEach((item, idx) => {
        const card = document.createElement('div');
        card.className = 'p-4 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition';
        const inner = document.createElement('div');
        inner.className = 'flex items-start justify-between';
        const left = document.createElement('p');
        left.className = 'text-gray-800 flex-1';
        // item.claim or item.claim_text or item.claim_text
        left.textContent = item.claim || item.claim_text || item.claimText || '';

        const verdict = item.verdict || 'UNVERIFIED';
        const cfg = verdictConfig[verdict] || verdictConfig.UNVERIFIED;
        const badge = document.createElement('span');
        badge.className = `ml-4 px-3 py-1 rounded-full text-sm font-semibold ${cfg.bg} ${cfg.color}`;
        badge.textContent = verdict;

        inner.appendChild(left);
        inner.appendChild(badge);
        card.appendChild(inner);
        // clicking a trending item will verify it (call /api/verify)
        card.addEventListener('click', async () => {
          // If claim_text exists, use it; else use left text
          const claimText = item.claim || item.claim_text || item.claimText || left.textContent;
          inputText.value = claimText;
          setMode('text');
          // trigger verification
          await verifyText();
        });

        trendingList.appendChild(card);
      });
    }

    /**************************************************************************
     * Loading state helper
     **************************************************************************/
    function setLoading(isLoading) {
      verifyTextBtn.disabled = isLoading;
      verifyUrlBtn.disabled = isLoading;
      if (isLoading) {
        verifyTextBtn.textContent = 'Verifying...';
        verifyUrlBtn.textContent = 'Verifying...';
      } else {
        verifyTextBtn.textContent = 'Verify Claim';
        verifyUrlBtn.textContent = 'Verify URL';
      }
    }

    /**************************************************************************
     * Event bindings
     **************************************************************************/
    modeTextBtn.addEventListener('click', () => setMode('text'));
    modeUrlBtn.addEventListener('click', () => setMode('url'));
    verifyTextBtn.addEventListener('click', verifyText);
    verifyUrlBtn.addEventListener('click', verifyUrl);
    btnTrending.addEventListener('click', fetchTrending);

    // initial UI state
    setMode('text');
    clearError();
    fetchTrending();

    // Initialize lucide icons in the DOM
    document.querySelectorAll('.lucide-icon').forEach(node => {
      // If the node has data-feather attribute, replace
      const name = node.getAttribute('data-feather') || node.getAttribute('data-icon');
      if (name) {
        const svg = createLucide(name, node.className || 'w-6 h-6');
        node.replaceWith(svg);
      }
    });
  </script>
</body>
</html>